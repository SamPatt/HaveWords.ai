{"version":3,"file":"dice-box.es.js","sources":["../src/components/world/canvas.js","../src/helpers/index.js","../src/WorldFacade.js"],"sourcesContent":["function createCanvas(options) {\n  const { selector, id } = options\n\n  if (!selector || typeof selector !== 'string') {\n    throw(new Error(\"You must provide a DOM selector as the first argument in order to render the Dice Box\"))\n  }\n\n  let canvas\n  const container = document.querySelector(selector)\n\n  if(!container?.nodeName){\n    throw(new Error(`DiceBox target DOM node: '${selector}' not found or not available yet. Try invoking inside a DOMContentLoaded event`))\n  }\n  \n  if(container.nodeName.toLowerCase() !== 'canvas') {\n    canvas = document.createElement('canvas')\n    canvas.id = id\n    container.appendChild(canvas)\n  } \n  else {\n    canvas = container\n  }\n  return canvas\n}\n\nexport { createCanvas }","export function lerp(a, b, alpha) {\n  return a * (1 - alpha) + b * alpha;\n}\n\n/**\n * Create UUIDs \n * @return {string} Unique UUID\n */\nexport const createUUID = () => {\n  return ([1e7]+-1e3+-4e3+-8e3+-1e11).replace(/[018]/g, c => {\n    const crypto = window.crypto || window.msCrypto\n    //eslint-disable-next-line\n    return (c ^ crypto.getRandomValues(new Uint8Array(1))[0] & 15 >> c / 4).toString(16)\n  })\n}\n\nexport const recursiveSearch = (obj, searchKey, results = []) => {\n\tconst r = results;\n\tObject.keys(obj).forEach(key => {\n\t\tconst value = obj[key];\n\t\t// if(key === searchKey && typeof value !== 'object'){\n\t\tif(key === searchKey){\n\t\t\tr.push(value);\n\t\t} else if(value && typeof value === 'object'){\n\t\t\trecursiveSearch(value, searchKey, r);\n\t\t}\n\t});\n\treturn r;\n};\n\n/**\n * Debounce functions for better performance\n * (c) 2021 Chris Ferdinandi, MIT License, https://gomakethings.com\n * @param  {Function} fn The function to debounce\n */\nexport const debounce = (fn) => {\n\n\t// Setup a timer\n\tlet timeout;\n\n\t// Return a function to run debounced\n\treturn function () {\n\n\t\t// Setup the arguments\n\t\tlet context = this;\n\t\tlet args = arguments;\n\n\t\t// If there's a timer, cancel it\n\t\tif (timeout) {\n\t\t\twindow.cancelAnimationFrame(timeout);\n\t\t}\n\n\t\t// Setup the new requestAnimationFrame()\n\t\ttimeout = window.requestAnimationFrame(function () {\n\t\t\tfn.apply(context, args);\n\t\t});\n\t};\n}\n\n/**\n * Function Queue - ensures async function calls are triggered in the order they are queued\n * By David Adler (david_adler) @ https://stackoverflow.com/questions/53540348/js-async-await-tasks-queue\n * @param  {object} opts Option to dedupe concurrent executions\n * @return {object} returns object with \"push\" function, \"queue\" array, and \"flush\" function\n */\nexport const createAsyncQueue = (opts = { dedupe: false }) => {\n  const { dedupe } = opts\n  let queue = []\n  let running\n  const push = task => {\n    if (dedupe) queue = []\n    queue.push(task)\n    if (!running) running = start()\n    return running.finally(() => {\n      running = undefined\n    })\n  }\n  const start = async () => {\n    const res = []\n    while (queue.length) {\n      const item = queue.shift()\n      res.push(await item())\n    }\n    return res\n  }\n  return { push, queue, flush: () => running || Promise.resolve([]) }\n}\n\n// deep copy objects and break references to original object\n// Note: does not work with the 'scene' object or objects with circular references\nexport const deepCopy = obj => JSON.parse(JSON.stringify(obj))\n\n// Sleeper function to delay execution for testing\nexport const sleeper = (ms) => {\n  return new Promise(resolve => setTimeout(() => resolve(), ms));\n}\n\nexport class Random {\n  /**\n   * Generate a random number between 0 (inclusive) and 1 (exclusive).\n   * A drop in replacement for Math.random()\n   * @return {number}\n   */\n  static value() {\n    const crypto = window.crypto || window.msCrypto;\n    const buffer = new Uint32Array(1);\n    const int = crypto.getRandomValues(buffer)[0];\n\n    return int / 2**32\n  }\n  /**\n   * Generate a very good random number between min (inclusive) and max (exclusive) by using crypto.getRandomValues() twice.\n   * @param  {number} min\n   * @param  {number} max\n   * @return {number}\n   */\n  static range(min, max) {\n    // return Math.floor(this.value() * (max - min) + min); // plain random\n    return (Math.floor(Math.pow(10,14)*this.value()*this.value())%(max-min+1))+min // super random!\n  }\n}\n\n// https://www.30secondsofcode.org/c/js-colors/p/1\nexport const hexToRGB = hex => {\n  let alpha = false,\n    h = hex.slice(hex.startsWith('#') ? 1 : 0);\n  if (h.length === 3) h = [...h].map(x => x + x).join('');\n  else if (h.length === 8) alpha = true;\n  h = parseInt(h, 16);\n  let val = {\n    r: h >>> 16,\n    g: (h & 0x00ff00) >>> 8,\n    b: (h & 0x0000ff)\n  }\n  if(alpha) {\n    val.r = h >>> 24\n    val.g = (h & 0x00ff0000) >>> 16\n    val.b = (h & 0x0000ff00) >>> 8\n    val.a = (h & 0x000000ff)\n  }\n  return val\n\n};\n\nexport const RGBToHSB = (r, g, b) => {\n  r /= 255;\n  g /= 255;\n  b /= 255;\n  const v = Math.max(r, g, b),\n    n = v - Math.min(r, g, b);\n  const h =\n    n === 0 ? 0 : n && v === r ? (g - b) / n : v === g ? 2 + (b - r) / n : 4 + (r - g) / n;\n  return [60 * (h < 0 ? h + 6 : h), v && (n / v) * 100, v * 100];\n};\n\nexport const hexToHSB = (hex) => {\n  const rgb = hexToRGB(hex)\n  return RGBToHSB(rgb.r,rgb.g,rgb.b)\n}","import { createCanvas } from './components/world/canvas'\nimport physicsWorker from './components/physics.worker.js?worker&inline'\nimport { debounce, createAsyncQueue, Random, hexToRGB } from './helpers'\n\nconst defaultOptions = {\n\tid: `dice-canvas-${Date.now()}`, // set the canvas id\n  enableShadows: true, // do dice cast shadows onto DiceBox mesh?\n\tshadowTransparency: .8,\n\tlightIntensity: 1,\n  delay: 10, // delay between dice being generated - 0 causes stuttering and physics popping\n\tscale: 5, // scale the dice\n\ttheme: 'default', // can be a hex color or a pre-defined theme such as 'purpleRock'\n\tthemeColor: '#2e8555', // used for color values or named theme variants - not fully implemented yet // green: #2e8555 // yellow: #feea03\n\toffscreen: true, // use offscreen canvas browser feature for performance improvements - will fallback to false based on feature detection\n\tassetPath: '/assets/dice-box/', // path to 'ammo', 'models', 'themes' folders and web workers\n\torigin: location.origin,\n\tmeshFile: `models/default.json`,\n\tsuspendSimulation: false\n}\n\nclass WorldFacade {\n\trollCollectionData = {}\n\trollGroupData = {}\n\trollDiceData = {}\n\tthemeData = []\n\tthemesLoadedData = {}\n\t#collectionIndex = 0\n\t#groupIndex = 0\n\t#rollIndex = 0\n\t#idIndex = 0\n\t#DiceWorld = {}\n\t#diceWorldPromise\n\t#diceWorldResolve\n\t#DicePhysics\n\t#dicePhysicsPromise\n\t#dicePhysicsResolve\n\tnoop = () => {}\n\n  constructor(container, options = {}){\n\t\tif(typeof options !== 'object') {\n\t\t\tthrow new Error('Config options should be an object. Config reference: https://fantasticdice.games/docs/usage/config#configuration-options')\n\t\t}\n\t\t// pull out callback functions from options\n\t\tconst { onDieComplete, onRollComplete, onRemoveComplete, onThemeConfigLoaded, onThemeLoaded, ...boxOptions } = options\n\n\t\t// extend defaults with options\n\t\tthis.config = {...defaultOptions, ...boxOptions}\n\n\t\t// assign callback functions\n\t\tthis.onDieComplete = options.onDieComplete || this.noop\n\t\tthis.onRollComplete = options.onRollComplete || this.noop\n\t\tthis.onRemoveComplete = options.onRemoveComplete || this.noop\n\t\tthis.onThemeLoaded = options.onThemeLoaded || this.noop\n\t\tthis.onThemeConfigLoaded = options.onThemeConfigLoaded || this.noop\n\n\n\t\t// if a canvas selector is provided then that will be used for the dicebox, otherwise a canvas will be created using the config.id\n    this.canvas = createCanvas({\n      selector: container,\n      id: this.config.id\n    })\n\t\t// create a queue to prevent theme being loaded multiple times\n\t\tthis.loadThemeQueue = createAsyncQueue({dedupe: true})\n  }\n\n\t// Load the BabylonJS World\n\tasync #loadWorld(){\n\n\t\t// set up a promise to be fulfilled when a message comes back from DiceWorld indicating init is complete\n\t\tthis.#diceWorldPromise = new Promise((resolve, reject) => {\n\t\t\tthis.#diceWorldResolve = resolve\n\t\t})\n\n\t\t// resolve the promise one onInitComplete callback is triggered\n\t\tconst onInitComplete = () => {\n\t\t\tthis.#diceWorldResolve()\n\t\t}\n\n\t\tif (\"OffscreenCanvas\" in window && \"transferControlToOffscreen\" in this.canvas && this.config.offscreen) {\n\t\t\t// Ok to use offscreen canvas - transfer control offscreen\n\t\t\tconst WorldOffscreen = await import('./components/world.offscreen').then(module => module.default)\n\t\t\t// WorldOffscreen is just a container class that passes all method calls to the Offscreen Canvas worker\n\t\t\tthis.#DiceWorld = new WorldOffscreen({\n\t\t\t\tcanvas: this.canvas,\n\t\t\t\toptions: this.config,\n\t\t\t\tonInitComplete\n\t\t\t})\n\t\t} else {\n\t\t\tif(this.config.offscreen){\n\t\t\t\tconsole.warn(\"This browser does not support OffscreenCanvas. Using standard canvas fallback.\")\n\t\t\t\tthis.config.offscreen = false\n\t\t\t}\n\t\t\t// code splitting out WorldOnscreen. It's essentially the same as offscreenCanvas.worker.js but communicates with the main thread differently\n\t\t\tconst WorldOnscreen = await import('./components/world.onscreen').then(module => module.default)\n\t\t\tthis.#DiceWorld = new WorldOnscreen({\n\t\t\t\tcanvas: this.canvas,\n\t\t\t\toptions: this.config,\n\t\t\t\tonInitComplete\n\t\t\t})\n\t\t}\n\t}\n\n\t// Load the AmmoJS physics world\n\t#loadPhysics(){\n\t\t// initialize physics world in which AmmoJS runs\n\t\tthis.#DicePhysics = new physicsWorker()\n\t\t// set up a promise to be fulfilled when a message comes back from physics.worker indicating init is complete\n\t\tthis.#dicePhysicsPromise = new Promise((resolve, reject) => {\n\t\t\tthis.#dicePhysicsResolve = resolve\n\t\t})\n\t\tthis.#DicePhysics.onmessage = (e) => {\n\t\t\tswitch( e.data.action ) {\n\t\t\t\tcase \"init-complete\":\n\t\t\t\t\tthis.#dicePhysicsResolve() // fulfill promise so other things can run\n\t\t\t}\n    }\n\t\t// initialize the AmmoJS physics worker\n\t\tthis.#DicePhysics.postMessage({\n\t\t\taction: \"init\",\n\t\t\twidth: this.canvas.clientWidth,\n\t\t\theight: this.canvas.clientHeight,\n\t\t\toptions: this.config\n\t\t})\n\t}\n\n\t#connectWorld(){\n\t\tconst channel = new MessageChannel()\n\t\t\n\t\t// create message channel for the visual world and the physics world to communicate through\n\t\tthis.#DiceWorld.connect(channel.port1)\n\n\t\t// create message channel for this WorldFacade class to communicate with physics world\n\t\tthis.#DicePhysics.postMessage({\n\t\t\taction: \"connect\"\n\t\t},[ channel.port2 ])\n\t}\n\n\tresizeWorld(){\n\t\t// send resize events to workers - debounced for performance\n\t\tconst resizeWorkers = () => {\n\t\t\tthis.#DiceWorld.resize({width: this.canvas.clientWidth, height: this.canvas.clientHeight})\n\t\t\tthis.#DicePhysics.postMessage({action: \"resize\", width: this.canvas.clientWidth, height: this.canvas.clientHeight});\n\t\t}\n\t\tconst debounceResize = debounce(resizeWorkers)\n\t\twindow.addEventListener(\"resize\", debounceResize)\n\t}\n\n  async init() {\n\t\t// trigger physics first so it can load in parallel with world\n\t\tthis.#loadPhysics()\n\t\tawait this.#loadWorld()\n\t\tthis.resizeWorld()\n\n\t\t// now that DiceWorld is ready we can attach our callbacks\n\t\tthis.#DiceWorld.onRollResult = (result) => {\n\t\t\tconst die = this.rollDiceData[result.rollId]\n\t\t\tconst group = this.rollGroupData[die.groupId]\n\t\t\tconst collection = this.rollCollectionData[die.collectionId]\n\n\t\t\t// map die results back to our rollData\n\t\t\t// since all rolls are references to this.rollDiceDate the values will be added to those objects\n\t\t\tgroup.rolls[die.rollId].value = result.value\n\n\t\t\t// increment the completed roll count for this group\n\t\t\tcollection.completedRolls++\n\t\t\t// if all rolls are completed then resolve the collection promise - returning dice that were in this collection\n\t\t\tif(collection.completedRolls == collection.rolls.length) {\n\t\t\t\t// pull out roll.collectionId and roll.id? They're meant to be internal values\n\t\t\t\tcollection.resolve(Object.values(collection.rolls).map(({collectionId, id, meshName, ...rest}) => rest))\n\t\t\t}\n\n\t\t\t// trigger callback passing individual die result\n\t\t\tconst {collectionId, id, ...returnDie} = die\n\t\t\tthis.onDieComplete(returnDie)\n\t\t}\n\t\tthis.#DiceWorld.onRollComplete = () => {\n\t\t\t// trigger callback passing the roll results\n\t\t\tthis.onRollComplete(this.getRollResults())\n\t\t}\n\n\t\tthis.#DiceWorld.onDieRemoved = (rollId) => {\n\t\t\t// get die information from cache\n\t\t\tlet die = this.rollDiceData[rollId]\n\t\t\tconst collection = this.rollCollectionData[die.removeCollectionId]\n\t\t\tcollection.completedRolls++\n\n\t\t\t// remove this die from cache\n\t\t\tdelete this.rollDiceData[die.rollId]\n\n\t\t\t// remove this die from it's group rolls\n\t\t\tconst group = this.rollGroupData[die.groupId]\n\t\t\tdelete group.rolls[die.rollId]\n\n\t\t\t// parse the group value now that the die has been removed from data\n\t\t\tconst groupData = this.#parseGroup(die.groupId)\n\t\t\t// update the value and quantity values\n\t\t\tgroup.value = groupData.value\n\t\t\tgroup.qty = groupData.rollsArray.length\n\n\t\t\t// if all rolls are completed then resolve the collection promise - returning dice that were removed\n\t\t\tif(collection.completedRolls == collection.rolls.length) {\n\t\t\t\tcollection.resolve(Object.values(collection.rolls).map(({id, ...rest}) => rest))\n\t\t\t}\n\t\t\tconst {collectionId, id, removeCollectionId, meshName, ...returnDie} = die\n\t\t\tthis.onRemoveComplete(returnDie)\n\t\t}\n\n    // wait for both DiceWorld and DicePhysics to initialize\n\t\tawait Promise.all([this.#diceWorldPromise, this.#dicePhysicsPromise])\n\t\t// set up message channels between Dice World and Dice Physics\n\n\t\tthis.#connectWorld()\n\n\t\t// queue load of the theme defined in the config\n\t\tawait this.loadThemeQueue.push(() => this.loadTheme(this.config.theme))\n\n\t\t//TODO: this should probably return a promise\n\t\t// make this method chainable\n\t\treturn this\n  }\n\n\t// fetch the theme config and return a themeData object\n\tasync getThemeConfig(theme){\n\t\tconst basePath = `${this.config.origin}${this.config.assetPath}themes/${theme}`\n\t\tlet themeData\n\n\t\tif (theme === 'default'){\n\t\t\t// sensible defaults\n\t\t\tthemeData = {\n\t\t\t\tname: \"Default Colors\",\n\t\t\t\tmaterial: {\n\t\t\t\t\ttype: \"color\",\n\t\t\t\t\tdiffuseTexture: {\n\t\t\t\t\t\tlight: 'diffuse-light.png',\n\t\t\t\t\t\tdark: 'diffuse-dark.png'\n\t\t\t\t\t},\n\t\t\t\t\tdiffuseLevel: 1,\n\t\t\t\t\tbumpTexture: 'normal.png',\n\t\t\t\t\tbumpLevel: .5,\n\t\t\t\t\tspecularTexture: 'specular.jpg',\n\t\t\t\t\tspecularPower: 1\n\t\t\t\t}\n\t\t\t}\n\t\t} else {\n\t\t\t// fetch the theme.config file\n\t\t\tthemeData = await fetch(`${basePath}/theme.config.json`).then(resp => {\n\t\t\t\tif(resp.ok) {\n\t\t\t\t\tconst contentType = resp.headers.get(\"content-type\")\n\t\t\t\t\tif (contentType && contentType.indexOf(\"application/json\") !== -1) {\n\t\t\t\t\t\treturn resp.json()\n\t\t\t\t\t} \n\t\t\t\t\telse if (resp.type && resp.type === 'basic') {\n\t\t\t\t\t\treturn resp.json()\n\t\t\t\t\t}\n\t\t\t\t\telse {\n\t\t\t\t\t\t// return resp\n\t\t\t\t\t\tthrow new Error(`Incorrect contentType: ${contentType}. Expected \"application/json\" or \"basic\"`)\n\t\t\t\t\t}\n\t\t\t\t} else {\n\t\t\t\t\tthrow new Error(`Unable to fetch config file for theme: '${theme}'. Request rejected with status ${resp.status}: ${resp.statusText}`)\n\t\t\t\t}\n\t\t\t}).catch(error => console.error(error))\n\t\t}\n\n\t\tlet meshFilePath = this.config.origin + this.config.assetPath + this.config.meshFile\n\t\tlet meshName = 'default'\n\t\tif(!themeData){\n\t\t\tthrow new Error(\"No theme config data to work with.\")\n\t\t}\n\t\tif(themeData.hasOwnProperty('meshFile')){\n\t\t\tmeshFilePath = `${basePath}/${themeData.meshFile}`\n\t\t\tif(!themeData.hasOwnProperty('meshName')) {\n\t\t\t\tconsole.warn('You should provide a meshName in your theme.config.json file')\n\t\t\t\t// fallback to fileName as meshName without extension\n\t\t\t\tmeshName = themeData.meshFile.replace(/(.*)\\..{2,4}$/,'$1')\n\t\t\t} else {\n\t\t\t\tmeshName = themeData.meshName\n\t\t\t}\n\t\t}\n\n\t\t// if diceAvailable is not specified then assume the default set of seven\n\t\tif(!themeData.hasOwnProperty('diceAvailable')){\n\t\t\tthemeData.diceAvailable = ['d4','d6','d8','d10','d12','d20','d100']\n\t\t}\n\n\t\tif(themeData.hasOwnProperty(\"extends\")){\n\t\t\tlet target = this.themesLoadedData[themeData.extends]\n\t\t\tif(!target){\n\t\t\t\ttarget = await this.loadTheme(themeData.extends).catch(error => console.error(error))\n\t\t\t}\n\t\t\tif(target){\n\t\t\t\tthemeData.diceInherited = [...(themeData.diceInherited || [])]\n\t\t\t\ttarget.diceAvailable.map(die => {\n\t\t\t\t\tthemeData.diceInherited[die] = target.systemName\n\t\t\t\t})\n\t\t\t}\n\t\t}\n\n\n\t\tObject.assign(themeData,\n\t\t\t{\n\t\t\t\tbasePath,\n\t\t\t\tmeshFilePath,\n\t\t\t\tmeshName,\n\t\t\t\ttheme,\n\t\t\t}\n\t\t)\n\n\t\t// this.onThemeConfigLoaded(themeData)\n\n\t\treturn themeData\n\t}\n\n\tasync loadTheme(theme){\n\t\t// check the cache\n\t\tif(this.themesLoadedData[theme]) {\n\t\t\t// short circuit if theme has been previously loaded\n\t\t\t// console.log(`${theme} has already been loaded. Returning cache`)\n\t\t\treturn this.themesLoadedData[theme]\n\t\t}\n\t\t// console.log(`${theme} is loading ...`)\n\n\t\t// fetch and save the themeData for later\n\t\tconst themeConfig = this.themesLoadedData[theme] = await this.getThemeConfig(theme).catch(error => console.error(error))\n\t\tthis.onThemeConfigLoaded(themeConfig)\n\n\t\tif(!themeConfig) return\n\n\t\t// pass config onto DiceWorld to load - the theme loader needs 'scene' from DiceWorld\n\t\tawait this.#DiceWorld.loadTheme(themeConfig).catch(error => console.error(error))\n\n\t\tthis.onThemeLoaded(themeConfig)\n\n\t\treturn themeConfig\n\t}\n\n\t// TODO: use getter and setter\n\t// change config options\n\tasync updateConfig(options) {\n\t\tconst newConfig = {...this.config,...options}\n\t\t// console.log('newConfig', newConfig)\n\t\tconst config = await this.loadThemeQueue.push(() => this.loadTheme(newConfig.theme))\n\t\t// const themeData = config.at(-1) //get the last entry returned from the queue\n\n\t\tthis.config = newConfig\n\t\t// pass updates to DiceWorld\n\t\tthis.#DiceWorld.updateConfig(newConfig)\n\t\t// pass updates to PhysicsWorld\n\t\tthis.#DicePhysics.postMessage({\n\t\t\taction: 'updateConfig',\n\t\t\toptions: newConfig\n\t\t})\n\n\t\t// make this method chainable\n\t\treturn this\n\t}\n\n\tclear() {\n\t\t// reset indexes\n\t\tthis.#collectionIndex = 0\n\t\tthis.#groupIndex = 0\n\t\tthis.#rollIndex = 0\n\t\tthis.#idIndex = 0\n\t\t// reset internal data objects\n\t\tthis.rollCollectionData = {}\n\t\tthis.rollGroupData = {}\n\t\tthis.rollDiceData = {}\n\t\t// clear all rendered die bodies\n\t\tthis.#DiceWorld.clear()\n    // clear all physics die bodies\n    this.#DicePhysics.postMessage({action: \"clearDice\"})\n\n\t\t// make this method chainable\n\t\treturn this\n  }\n\n\thide() {\n\t\tthis.canvas.style.display = 'none'\n\n\t\t// make this method chainable\n\t\treturn this\n\t}\n\n\tshow() {\n\t\tthis.canvas.style.display = 'block'\n\n\t\t// make this method chainable\n\t\treturn this\n\t}\n\n\t// TODO: pass data with roll - such as roll name. Passed back at the end in the results\n\troll(notation, {theme = this.config.theme, themeColor = this.config.themeColor, newStartPoint = true} = {}) {\n\t\t// note: to add to a roll on screen use .add method\n\t\t// reset the offscreen worker and physics worker with each new roll\n\t\tthis.clear()\n\t\tconst collectionId = this.#collectionIndex++\n\t\t\n\t\tthis.rollCollectionData[collectionId] = new Collection({\n\t\t\tid: collectionId,\n\t\t\tnotation,\n\t\t\ttheme,\n\t\t\tthemeColor,\n\t\t\tnewStartPoint\n\t\t})\n\n\t\tconst parsedNotation = this.createNotationArray(notation, this.themesLoadedData[theme].diceAvailable)\n\t\tthis.#makeRoll(parsedNotation, collectionId)\n\n\t\t// returns a Promise that is resolved in onRollComplete\n\t\treturn this.rollCollectionData[collectionId].promise\n\t}\n\n  add(notation, {theme = this.config.theme, themeColor = this.config.themeColor, newStartPoint = true} = {}) {\n\n\t\tconst collectionId = this.#collectionIndex++\n\n\t\tthis.rollCollectionData[collectionId] = new Collection({\n\t\t\tid: collectionId,\n\t\t\tnotation,\n\t\t\ttheme,\n\t\t\tthemeColor,\n\t\t\tnewStartPoint\n\t\t})\n\t\t\n\t\tconst parsedNotation = this.createNotationArray(notation, this.themesLoadedData[theme].diceAvailable)\n\t\tthis.#makeRoll(parsedNotation, collectionId)\n\n\t\t// returns a Promise that is resolved in onRollComplete\n\t\treturn this.rollCollectionData[collectionId].promise\n  }\n\n\treroll(notation, {remove = false, hide = false, newStartPoint = true} = {}) {\n\t\t// TODO: add hide if you want to keep the die result for an external parser\n\n\t\t// ensure notation is an array\n\t\tconst rollArray = Array.isArray(notation) ? notation : [notation]\n\n\t\t// destructure out 'sides', 'theme', 'groupId', 'rollId' - basically just getting rid of value - could do ({value, ...rest}) => rest\n\t\tconst cleanNotation = rollArray.map(({value, ...rest}) => rest)\n\n\t\tif(remove === true){\n\t\t\tthis.remove(cleanNotation, {hide})\n\t\t}\n\n\t\t// .add will return a promise that will then be returned here\n\t\treturn this.add(cleanNotation, {newStartPoint})\n\t}\n\n\tremove(notation, {hide = false} = {}) {\n\t\t// ensure notation is an array\n\t\tconst rollArray = Array.isArray(notation) ? notation : [notation]\n\n\t\tconst collectionId = this.#collectionIndex++\n\n\t\tthis.rollCollectionData[collectionId] = new Collection({\n\t\t\tid: collectionId,\n\t\t\tnotation,\n\t\t\trolls: rollArray,\n\t\t})\n\n\t\t// loop through each die to be removed\n\t\trollArray.map(die => {\n\t\t\t// add the collectionId to the die so it can be looked up in the callback\n\t\t\tthis.rollDiceData[die.rollId].removeCollectionId = collectionId\n\t\t\t// assign the id for this die from our cache - required for removal\n\t\t\t// die.id = this.rollDiceData[die.rollId].id - note: can appear in async roll result data if attached to die object\n\t\t\tlet id = this.rollDiceData[die.rollId].id\n\t\t\t// remove the die from the render - don't like having to pass two ids. rollId is passed over just so it can be passed back for callback\n\t\t\tthis.#DiceWorld.remove({id,rollId: die.rollId})\n\t\t\t// remove the die from the physics bodies\n\t\t\tthis.#DicePhysics.postMessage({action: \"removeDie\", id })\n\t\t})\n\n\t\treturn this.rollCollectionData[collectionId].promise\n\t}\n\n\t// used by both .add and .roll - .roll clears the box and .add does not\n\tasync #makeRoll(parsedNotation, collectionId){\n\n\t\tconst collection = this.rollCollectionData[collectionId]\n\t\tlet newStartPoint = collection.newStartPoint\n\n\t\t// loop through the number of dice in the group and roll each one\n\t\tparsedNotation.forEach(async notation => {\n\t\t\tif(!notation.sides) {\n\t\t\t\tthrow new Error(\"Improper dice notation or unable to parse notation\")\n\t\t\t}\n\t\t\tconst theme = notation.theme || collection.theme || this.config.theme\n\t\t\tconst themeColor = notation.themeColor || collection.themeColor || this.config.themeColor\n\t\t\tconst rolls = {}\n\t\t\tconst hasGroupId = notation.groupId !== undefined\n\t\t\tlet index\n\n\t\t\t\n\t\t\t// load the theme, will be short circuited if previously loaded\n\t\t\tconst loadTheme = () => this.loadTheme(theme)\n\t\t\tawait this.loadThemeQueue.push(loadTheme)\n\n\t\t\tconst {meshName, diceAvailable, diceInherited = {}, material: { type: materialType }} = this.themesLoadedData[theme]\n\t\t\tconst diceExtra = Object.keys(diceInherited)\n\n\t\t\tlet colorSuffix = '', color\n\n\t\t\tif(materialType === \"color\") {\n\t\t\t\tcolor = hexToRGB(themeColor)\n\t\t\t\t// dat.gui uses HSB(a.k.a HSV) brightness greater than .5 and saturation less than .5\n\t\t\t\tcolorSuffix = ((color.r*0.299 + color.g*0.587 + color.b*0.114) > 175) ? '_dark' : '_light'\n\t\t\t}\n\n\t\t\t// TODO: should I validate that added dice are only joining groups of the same \"sides\" value - e.g.: d6's can only be added to groups when sides: 6? Probably.\n\t\t\tfor (var i = 0, len = notation.qty; i < len; i++) {\n\t\t\t\t// id's start at zero and zero can be falsy, so we check for undefined\n\t\t\t\tlet rollId = notation.rollId !== undefined ? notation.rollId : this.#rollIndex++\n\t\t\t\tlet id = notation.id !== undefined ? notation.id : this.#idIndex++\n\t\t\t\tindex = hasGroupId ? notation.groupId : this.#groupIndex\n\n\t\t\t\tconst dieType = Number.isInteger(notation.sides) ? `d${notation.sides}` : notation.sides\n\n\t\t\t\tnotation.sides = dieType\n\n\t\t\t\tconst roll = {\n\t\t\t\t\tsides: dieType,\n\t\t\t\t\tgroupId: index,\n\t\t\t\t\tcollectionId: collection.id,\n\t\t\t\t\trollId,\n\t\t\t\t\tid,\n\t\t\t\t\ttheme,\n\t\t\t\t\tthemeColor,\n\t\t\t\t\tmeshName\n\t\t\t\t}\n\n\t\t\t\trolls[rollId] = roll\n\t\t\t\tthis.rollDiceData[rollId] = roll\n\t\t\t\tcollection.rolls.push(this.rollDiceData[rollId])\n\n\t\t\t\t// TODO: eliminate the 'd' for more flexible naming such as 'fate' - ensure numbers are strings\n\t\t\t\tif (roll.sides === 'fate' && (!diceAvailable.includes(roll.sides) && !diceExtra.includes(roll.sides))){\n\t\t\t\t\tconsole.warn(`fate die unavailable in '${theme}' theme. Using fallback.`)\n\t\t\t\t\tconst min = -1\n\t\t\t\t\tconst max = 1\n\t\t\t\t\troll.value = Random.range(min,max)\n\t\t\t\t\tthis.#DiceWorld.addNonDie(roll)\n\t\t\t\t} \n\t\t\t\telse if(this.config.suspendSimulation || (!diceAvailable.includes(roll.sides) && !diceExtra.includes(roll.sides))){\n\t\t\t\t\t// check if the requested roll is available in the current theme, if not then use crypto fallback\n\t\t\t\t\tconsole.warn(this.config.suspendSimulation ? \"3D simulation suspended. Using fallback.\" : `${roll.sides} die unavailable in '${theme}' theme. Using fallback.`)\n\t\t\t\t\troll.value = Random.range(1, roll.sides)\n\t\t\t\t\tthis.#DiceWorld.addNonDie(roll)\n\t\t\t\t} \n\t\t\t\telse {\n\t\t\t\t\tlet parentTheme\n\t\t\t\t\tif(diceExtra.includes(roll.sides)) {\n\t\t\t\t\t\tconst parentThemeName = diceInherited[roll.sides]\n\t\t\t\t\t\tparentTheme = this.themesLoadedData[parentThemeName]\n\t\t\t\t\t}\n\t\t\t\t\tthis.#DiceWorld.add({\n\t\t\t\t\t\t...roll,\n\t\t\t\t\t\tnewStartPoint,\n\t\t\t\t\t\ttheme: parentTheme?.systemName || theme,\n\t\t\t\t\t\tmeshName: parentTheme?.meshName || meshName,\n\t\t\t\t\t\tcolorSuffix\n\t\t\t\t\t})\n\t\t\t\t}\n\n\t\t\t\t// turn flag off\n\t\t\t\tnewStartPoint = false\n\t\t\t}\n\n\t\t\tif(hasGroupId) {\n\t\t\t\tObject.assign(this.rollGroupData[index].rolls, rolls)\n\t\t\t} else {\n\t\t\t\t// save this roll group for later\n\t\t\t\tnotation.rolls = rolls\n\t\t\t\tnotation.id = index\n\t\t\t\tthis.rollGroupData[index] = notation\n\t\t\t\t++this.#groupIndex\n\t\t\t}\n\t\t})\n\t}\n\n\t// accepts simple notations eg: 4d6\n\t// accepts array of notations eg: ['4d6','2d10']\n\t// accepts object {sides:int, qty:int}\n\t// accepts array of objects eg: [{sides:int, qty:int, mods:[]}]\n\tcreateNotationArray(input, diceAvailable){\n\t\tconst notation = Array.isArray( input ) ? input : [ input ]\n\t\tlet parsedNotation = []\n\n\n\t\tconst verifyObject = ( object ) => {\n\t\t\tif(!object.hasOwnProperty('qty')) {\n\t\t\t\tobject.qty = 1\n\t\t\t}\n\t\t\tif ( object.hasOwnProperty('sides') ) {\n\t\t\t\treturn true\n\t\t\t} else {\n\t\t\t\tconst err = \"Roll notation is missing sides\"\n\t\t\t\tthrow new Error(err);\n\t\t\t}\n\t\t}\n\n\t\tconst incrementId = (key) => {\n\t\t\tkey = key.toString()\n\t\t\tlet splitKey = key.split(\".\")\n\t\t\tif(splitKey[1]){\n\t\t\t\tsplitKey[1] = parseInt(splitKey[1]) + 1\n\t\t\t} else {\n\t\t\t\tsplitKey[1] = 1\n\t\t\t}\n\t\t\treturn splitKey[0] + \".\" + splitKey[1]\n\t\t}\n\n\t\t// verify that the rollId is unique. If not then increment it by .1\n\t\t// rollIds become keys in the rollDiceData object, so they must be unique or they will overwrite another entry\n\t\tconst verifyRollId = ( object ) => {\n\t\t\tif(object.hasOwnProperty('rollId')){\n\t\t\t\tif(this.rollDiceData.hasOwnProperty(object.rollId)){\n\t\t\t\t\tobject.rollId = incrementId(object.rollId)\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\t// notation is an array of strings or objects\n\t\tnotation.forEach(roll => {\n\t\t\t// console.log('roll', roll)\n\t\t\t// if notation is an array of strings\n\t\t\tif ( typeof roll === 'string' ) {\n\t\t\t\tparsedNotation.push( this.parse( roll, diceAvailable ) )\n\t\t\t} else if ( typeof notation === 'object' ) {\n\t\t\t\tverifyRollId( roll )\n\t\t\t\tverifyObject( roll )  && parsedNotation.push( roll )\n\t\t\t}\n\t\t})\n\n\t\treturn parsedNotation\n\t}\n\n  // parse text die notation such as 2d10+3 => {number:2, type:6, modifier:3}\n  // taken from https://github.com/ChapelR/dice-notation\n  parse(notation, diceAvailable) {\n    const diceNotation = /(\\d+)([dD]{1}\\d+)(.*)$/i\n\t\tconst percentNotation = /(\\d+)[dD]([0%]+)(.*)$/i\n\t\tconst fudgeNotation = /(\\d+)[dD](f+[ate]*)(.*)$/i\n\t\t// const customNotation = /(\\d+)[dD](.*)([+-])/i\n\t\tconst customNotation = /(\\d+)[dD]([\\d\\w]+)([+-]{0,1}\\d+)?/i\n    const modifier = /([+-])(\\d+)/\n    const cleanNotation = notation.trim().replace(/\\s+/g, '')\n    const validNumber = (n, err) => {\n      n = Number(n)\n      if (Number.isNaN(n) || !Number.isInteger(n) || n < 1) {\n        throw new Error(err);\n      }\n      return n\n    }\n\n\t\t// match percentNotation before diceNotation\n    const roll = cleanNotation.match(percentNotation) || cleanNotation.match(diceNotation) || cleanNotation.match(fudgeNotation) || cleanNotation.match(customNotation);\n\n\t\tlet mod = 0;\n    const msg = 'Invalid notation: ' + notation + '';\n\n    if (!roll || !roll.length || roll.length < 3) {\n      throw new Error(msg);\n    }\n    if (roll[3] && modifier.test(roll[3])) {\n      const modParts = roll[3].match(modifier);\n      let basicMod = validNumber(modParts[2], msg);\n      if (modParts[1].trim() === '-') {\n        basicMod *= -1;\n      }\n      mod = basicMod;\n    }\n\n\t\tconst returnObj = {\n\t\t\tqty : validNumber(roll[1], msg),\n      modifier: mod,\n\t\t}\n\n\t\tif(cleanNotation.match(percentNotation)){\n\t\t\treturnObj.sides = '100' // as string, not number\n\t\t} else if(cleanNotation.match(fudgeNotation)){\n\t\t\treturnObj.sides = 'fate' // force lowercase\n\t\t} else if(diceAvailable.includes(cleanNotation.match(customNotation)[2])){\n\t\t\treturnObj.sides = roll[2] // dice type instead of number\n\t\t} else {\n\t\t\treturnObj.sides = roll[2];\n\t\t}\n\n    return returnObj\n  }\n\n\t#parseGroup(groupId) {\n\t\t// console.log('groupId', groupId)\n\t\tconst rollGroup = this.rollGroupData[groupId]\n\t\t// turn object into an array\n\t\tconst rollsArray = Object.values(rollGroup.rolls).map(({collectionId, id, meshName, ...rest}) => rest)\n\t\t// add up the values\n\t\t// some dice may still be rolling, should this be a promise?\n\t\t// if dice are still rolling in the group then the value is undefined - hence the isNaN check\n\t\tlet value = rollsArray.reduce((val,roll) => {\n\t\t\tconst rollVal = isNaN(roll.value) ? 0 : roll.value\n\t\t\treturn val + rollVal\n\t\t},0)\n\t\t// add the modifier\n\t\tvalue += rollGroup.modifier ? rollGroup.modifier : 0\n\t\t// return the value and the rollsArray\n\t\treturn {value, rollsArray}\n\t}\n\n\tgetRollResults(){\n\t\t// loop through each roll group\n\t\treturn Object.entries(this.rollGroupData).map(([key,val]) => {\n\t\t\t// parse the group data to get the value and the rolls as an array\n\t\t\tconst groupData = this.#parseGroup(key)\n\t\t\t// set the value for this roll group in this.rollGroupData\n\t\t\tval.value = groupData.value\n\t\t\t// set the qty equal to the number of rolls - this can be changed by rerolls and removals\n\t\t\tval.qty = groupData.rollsArray.length\n\t\t\t// copy the group that will be put into the return object\n\t\t\tconst groupCopy = {...val}\n\t\t\t// replace the rolls object with a rolls array\n\t\t\tgroupCopy.rolls = groupData.rollsArray\n\t\t\t// return the groupCopy - note: we never return this.rollGroupData\n\t\t\treturn groupCopy\n\t\t})\n\t}\n}\n\nclass Collection{\n\tconstructor(options){\n\t\tObject.assign(this,options)\n\t\tthis.rolls = options.rolls || []\n\t\tthis.completedRolls = 0\n\t\tconst that = this\n\t\tthis.promise = new Promise((resolve,reject) => {\n\t\t\tthat.resolve = resolve\n\t\t\tthat.reject = reject\n\t\t})\n\t}\n}\n\nexport default WorldFacade"],"names":["createCanvas","options","selector","id","canvas","container","debounce","fn","timeout","context","args","createAsyncQueue","opts","dedupe","queue","running","push","task","start","res","item","deepCopy","obj","Random","crypto","buffer","min","max","hexToRGB","hex","alpha","h","x","val","defaultOptions","_collectionIndex","_groupIndex","_rollIndex","_idIndex","_DiceWorld","_diceWorldPromise","_diceWorldResolve","_DicePhysics","_dicePhysicsPromise","_dicePhysicsResolve","_loadWorld","loadWorld_fn","_loadPhysics","loadPhysics_fn","_connectWorld","connectWorld_fn","_makeRoll","makeRoll_fn","_parseGroup","parseGroup_fn","WorldFacade","__privateAdd","__publicField","onDieComplete","onRollComplete","onRemoveComplete","onThemeConfigLoaded","onThemeLoaded","boxOptions","debounceResize","__privateGet","__privateMethod","result","die","group","collection","collectionId","meshName","rest","returnDie","rollId","groupData","removeCollectionId","theme","basePath","themeData","resp","contentType","error","meshFilePath","target","themeConfig","newConfig","__privateSet","notation","themeColor","newStartPoint","__privateWrapper","Collection","parsedNotation","remove","hide","cleanNotation","value","rollArray","input","diceAvailable","verifyObject","object","err","incrementId","key","splitKey","verifyRollId","roll","diceNotation","percentNotation","fudgeNotation","customNotation","modifier","validNumber","n","mod","msg","modParts","basicMod","returnObj","groupCopy","resolve","reject","onInitComplete","WorldOffscreen","module","WorldOnscreen","physicsWorker","e","channel","rolls","hasGroupId","index","loadTheme","diceInherited","materialType","diceExtra","colorSuffix","color","i","len","dieType","parentTheme","parentThemeName","groupId","rollGroup","rollsArray","rollVal","that"],"mappings":"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"}